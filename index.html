<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>오늘의 목표</title>
    <!-- Tailwind CSS CDN을 사용하여 간편하게 스타일링합니다. -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN을 사용하여 그래프를 그립니다. -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Firebase SDK CDN -->
    <script type="module">
        // Firebase 관련 모듈을 가져옵니다.
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Firebase 설정 객체. 여기에 본인의 Firebase 프로젝트 설정 정보를 붙여넣으세요.
        // 이 정보는 Firebase 프로젝트 생성 후 웹 앱 등록 시 제공됩니다.
        // **** 이 중괄호 { } 안에 여러분의 Firebase 설정 코드를 붙여넣으세요! ****
        const firebaseConfig = {
            apiKey: "AIzaSyAIDXnY2dIwGpqiZnPt7nAV5UIJR1Uf0nA", // Firebase에서 복사한 apiKey를 여기에 붙여넣으세요.
            authDomain: "mydailygoalsapp.firebaseapp.com", // Firebase에서 복사한 authDomain을 여기에 붙여넣으세요. (오타 수정됨)
            projectId: "mydailygoalsapp", // Firebase에서 복사한 projectId를 여기에 붙여넣으세요.
            storageBucket: "mydailygoalsapp.firebasestorage.app", // Firebase에서 복사한 storageBucket을 여기에 붙여넣으세요.
            messagingSenderId: "688214176222", // Firebase에서 복사한 messagingSenderId를 여기에 붙여넣으세요. (오타 수정됨)
            appId: "1:688214176222:web:3285cdf9788dc36b42ad4f", // Firebase에서 복사한 appId를 여기에 붙여넣으세요.
            // measurementId: "G-1SNX5SR53T" // Google Analytics를 사용하지 않으면 필요 없습니다. (제거됨)
        };

        // Canvas 환경에서 제공되는 전역 변수를 사용합니다.
        // 이 부분은 Canvas 환경에서 앱을 실행할 때 자동으로 설정되므로, 수정할 필요 없습니다.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;
        const firebaseConfigFromCanvas = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : firebaseConfig;

        // Firebase 앱 초기화
        const app = initializeApp(firebaseConfigFromCanvas);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // 전역 변수로 선언하여 다른 스크립트에서도 접근할 수 있도록 합니다.
        window.firebaseApp = app;
        window.firebaseAuth = auth;
        window.firebaseDb = db;
        window.appId = appId;
        window.initialAuthToken = initialAuthToken;
    </script>

    <style>
        /* 기본 폰트 설정 및 배경색 (블랙 테마) */
        body {
            font-family: 'Inter', sans-serif; /* Inter 폰트 사용 */
            background-color: #1a1a1a; /* 어두운 배경색 */
            display: flex;
            justify-content: center; /* 가로 중앙 정렬 */
            align-items: center; /* 세로 중앙 정렬 */
            min-height: 100vh; /* 뷰포트 높이 전체 사용 */
            padding: 20px;
            box-sizing: border-box;
        }

        /* 컨테이너 스타일 (블랙 테마) */
        .container {
            background-color: #2c2c2c; /* 컨테이너 배경색 */
            padding: 30px;
            border-radius: 16px; /* 더 둥근 모서리 */
            box-shadow: 0 8px 25px rgba(0, 0, 0, 0.3); /* 더 깊은 그림자 */
            width: 100%;
            max-width: 500px; /* 로그인 화면 크기 조정을 위해 max-width를 500px로 줄였습니다. */
            text-align: center;
            border: 1px solid #444444; /* 테두리 추가 */
            color: #f0f0f0; /* 기본 텍스트 색상 */
        }

        /* 제목 스타일 (블랙 테마) */
        h1 {
            color: #f0f0f0; /* 밝은 텍스트 색상 */
            margin-bottom: 30px;
            font-size: 4em; /* 더 큰 글꼴로 수정 */
            font-weight: 700; /* 굵은 글꼴 */
        }

        h2 {
            color: #e0e0e0; /* 약간 어두운 밝은 텍스트 색상 */
            margin-top: 40px;
            margin-bottom: 20px;
            font-size: 1.8em;
            font-weight: 600;
        }

        /* 섹션 구분 스타일 (블랙 테마) */
        .section-card {
            border: 1px solid #4a4a4a;
            padding: 25px;
            border-radius: 12px;
            margin-bottom: 30px;
            background-color: #3a3a3a; /* 섹션 카드 배경색 */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* 입력 필드 스타일 (블랙 테마) */
        .input-area input[type="text"],
        .input-area input[type="email"],
        .input-area input[type="password"] {
            width: calc(100% - 20px);
            padding: 14px;
            margin-bottom: 12px;
            border: 1px solid #666666;
            border-radius: 8px;
            font-size: 1.1em;
            outline: none; /* 포커스 시 아웃라인 제거 */
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            background-color: #444444; /* 입력 필드 배경색 */
            color: #f0f0f0; /* 입력 필드 텍스트 색상 */
        }

        .input-area input[type="text"]:focus,
        .input-area input[type="email"]:focus,
        .input-area input[type="password"]:focus {
            border-color: #6a9ee8; /* 포커스 시 밝은 파란색 테두리 */
            box-shadow: 0 0 0 3px rgba(106, 158, 232, 0.3);
        }

        /* 버튼 스타일 (블랙 테마) */
        button {
            background-color: #6a9ee8; /* 파란색 */
            color: white;
            padding: 14px 25px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 1.1em;
            font-weight: 600;
            transition: background-color 0.3s ease, transform 0.2s ease;
            margin-top: 15px;
            box-shadow: 0 4px 10px rgba(106, 158, 232, 0.3);
        }

        button:hover {
            background-color: #5a8ed7; /* 어두운 파란색 */
            transform: translateY(-2px); /* 살짝 위로 이동 */
        }

        /* 목표 목록 스타일 (블랙 테마) */
        #goal-list {
            list-style: none;
            padding: 0;
            text-align: left;
        }

        #goal-list li {
            background-color: #4a4a4a; /* 리스트 아이템 배경색 */
            margin-bottom: 12px;
            padding: 18px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1.15em;
            color: #f0f0f0; /* 리스트 아이템 텍스트 색상 */
            box-shadow: 0 1px 4px rgba(0, 0, 0, 0.15);
            transition: background-color 0.3s ease;
        }

        #goal-list li.completed {
            background-color: #5a6a5a; /* 완료된 리스트 아이템 배경색 (어두운 초록) */
            text-decoration: line-through;
            color: #a0a0a0; /* 완료된 텍스트 색상 */
            opacity: 0.8;
        }

        /* 체크박스 스타일 (블랙 테마) */
        #goal-list li input[type="checkbox"] {
            margin-left: 15px;
            width: 24px; /* 더 큰 체크박스 */
            height: 24px;
            cursor: pointer;
            accent-color: #7ed957; /* 밝은 초록색 체크박스 */
            border-radius: 4px;
        }

        /* 메시지 박스 스타일 (블랙 테마) */
        #message-box {
            background-color: #6a9ee8; /* 메시지 박스 배경색 */
            color: white;
            padding: 15px;
            border-radius: 8px;
            margin-top: 20px;
            display: none; /* 기본적으로 숨김 */
            opacity: 0;
            transition: opacity 0.5s ease;
            font-weight: 500;
        }

        #message-box.show {
            display: block;
            opacity: 1;
        }

        /* 탭 버튼 스타일 (블랙 테마) */
        .tab-buttons {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-bottom: 20px;
        }

        .tab-buttons button {
            background-color: #4a4a4a; /* 탭 버튼 배경색 */
            color: #e0e0e0; /* 탭 버튼 텍스트 색상 */
            padding: 10px 20px;
            border-radius: 8px;
            font-weight: 600;
            transition: background-color 0.3s ease, color 0.3s ease;
            margin-top: 0; /* 기본 버튼 마진 제거 */
            box-shadow: none; /* 기본 버튼 그림자 제거 */
        }

        .tab-buttons button.active {
            background-color: #6a9ee8; /* 활성 탭 버튼 배경색 */
            color: white;
            box-shadow: 0 4px 10px rgba(106, 158, 232, 0.3);
        }

        .tab-buttons button:hover:not(.active) {
            background-color: #5a5a5a; /* 호버 시 탭 버튼 배경색 */
            color: #f0f0f0;
            transform: none; /* 호버 시 이동 효과 제거 */
        }

        /* 그래프 컨테이너 (블랙 테마) */
        .chart-container {
            width: 100%;
            /* max-width: 600px; */ /* 컨테이너 크기에 맞춰 100%로 설정 */
            margin: 20px auto 0;
            background-color: #3a3a3a; /* 그래프 컨테이너 배경색 */
            padding: 20px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
        }

        /* 응원 문구 스타일 */
        #encouragement-message {
            color: #7ed957; /* 밝은 초록색 */
            font-size: 1.2em;
            font-weight: 600;
            margin-bottom: 20px;
            text-align: center;
        }

        /* 월간 달력 스타일 */
        #monthly-calendar-view {
            display: none; /* 기본적으로 숨김 */
            /* chart-container 스타일을 재사용 */
        }

        .calendar-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
            color: #f0f0f0;
        }

        .calendar-header button {
            background-color: #4a4a4a;
            color: #e0e0e0;
            padding: 8px 12px;
            border-radius: 6px;
            font-weight: 500;
            transition: background-color 0.2s;
            margin-top: 0; /* 버튼 기본 마진 제거 */
            box-shadow: none;
        }

        .calendar-header button:hover {
            background-color: #5a5a5a;
            transform: none;
        }

        .calendar-weekdays {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
            margin-bottom: 10px;
            font-weight: 600;
        }

        .calendar-weekdays div {
            text-align: center;
            padding: 8px 0;
            color: #a0a0a0;
        }

        .calendar-weekdays div:nth-child(6) { color: #e57373; } /* 토요일 */
        .calendar-weekdays div:nth-child(7) { color: #e57373; } /* 일요일 */

        #calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, 1fr);
            gap: 5px;
        }

        .calendar-day {
            background-color: #4a4a4a;
            border-radius: 8px;
            padding: 10px 5px;
            min-height: 80px; /* 최소 높이 설정 */
            display: flex;
            flex-direction: column;
            justify-content: flex-start;
            align-items: center;
            font-size: 0.9em;
            color: #f0f0f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
            transition: background-color 0.2s;
            cursor: pointer; /* 클릭 가능하도록 커서 변경 */
        }

        .calendar-day:hover {
            background-color: #5a5a5a; /* 호버 효과 */
        }

        .calendar-day.other-month {
            background-color: #3a3a3a;
            color: #888888;
            cursor: default; /* 비활성 날짜는 커서 변경 안함 */
        }
        .calendar-day.other-month:hover {
            background-color: #3a3a3a; /* 호버 효과 제거 */
        }

        .calendar-day.today {
            border: 2px solid #6a9ee8; /* 오늘 날짜 강조 */
            box-shadow: 0 0 0 3px rgba(106, 158, 232, 0.3);
        }

        .calendar-day .day-number {
            font-weight: 700;
            font-size: 1.1em;
            margin-bottom: 5px;
        }

        .calendar-day .stars {
            font-size: 1.2em;
            color: #ffd700; /* 별 색상 */
            margin-top: auto; /* 아래쪽 정렬 */
        }

        /* 모달 (팝업) 스타일 */
        #daily-goal-modal {
            position: fixed;
            inset: 0; /* 화면 전체를 덮음 */
            background-color: rgba(0, 0, 0, 0.75); /* 반투명 검정 배경 */
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 1rem;
            z-index: 1000; /* 다른 요소 위에 표시 */
            display: none; /* 기본적으로 숨김 */
        }

        #daily-goal-modal-content {
            background-color: #3a3a3a; /* 모달 내용 배경색 */
            padding: 1.5rem;
            border-radius: 0.75rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.5);
            width: 100%;
            max-width: 400px; /* 모달 최대 너비 */
            position: relative;
            color: #f0f0f0;
        }

        #close-modal-btn {
            position: absolute;
            top: 0.75rem;
            right: 0.75rem;
            background: none;
            border: none;
            font-size: 2rem;
            color: #a0a0a0;
            cursor: pointer;
            line-height: 1; /* x 버튼이 중앙에 오도록 */
            padding: 0; /* 기본 패딩 제거 */
            margin: 0; /* 기본 마진 제거 */
            box-shadow: none; /* 버튼 그림자 제거 */
            transition: color 0.2s ease;
        }
        #close-modal-btn:hover {
            color: #f0f0f0;
            transform: none; /* 호버 시 이동 효과 제거 */
        }

        #modal-goal-list {
            list-style: none;
            padding: 0;
            margin-top: 1rem;
        }

        #modal-goal-list li {
            background-color: #4a4a4a;
            margin-bottom: 0.75rem;
            padding: 1rem;
            border-radius: 0.5rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
            font-size: 1em;
            color: #f0f0f0;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        #modal-goal-list li.completed {
            background-color: #5a6a5a;
            text-decoration: line-through;
            color: #a0a0a0;
        }

        #modal-goal-list li input[type="checkbox"] {
            width: 20px;
            height: 20px;
            accent-color: #7ed957;
            margin-left: 1rem;
        }

        #save-modal-status-btn {
            width: 100%;
            margin-top: 1.5rem;
        }

        /* 로그인/회원가입 폼 스타일 */
        #login-view {
            display: none; /* 초기에는 숨김 */
        }
        .auth-toggle-btn {
            background: none;
            border: none;
            color: #6a9ee8;
            cursor: pointer;
            font-size: 0.9em;
            margin-top: 10px;
            padding: 5px;
            box-shadow: none;
            transition: color 0.2s ease;
        }
        .auth-toggle-btn:hover {
            color: #5a8ed7;
            transform: none;
        }

        /* 모바일 반응형 디자인 */
        @media (max-width: 768px) {
            .container {
                padding: 20px;
                margin: 10px;
            }
            h1 {
                font-size: 2em;
            }
            h2 {
                font-size: 1.5em;
            }
            .section-card {
                padding: 15px;
            }
            .input-area input[type="text"],
            .input-area input[type="email"],
            .input-area input[type="password"],
            button {
                font-size: 1em;
                padding: 12px;
            }
            #goal-list li, #modal-goal-list li {
                font-size: 1em;
                padding: 15px;
            }
            .tab-buttons {
                flex-direction: column;
            }
            .tab-buttons button {
                width: 100%;
            }
            .calendar-day {
                min-height: 60px;
                font-size: 0.8em;
            }
            .calendar-day .day-number {
                font-size: 1em;
            }
            .calendar-day .stars {
                font-size: 1em;
            }
            #daily-goal-modal-content {
                padding: 1rem;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- 현재 날짜를 표시하는 제목 -->
        <h1><span id="current-date"></span> 오늘의 목표</h1>

        <!-- 메시지 박스 영역 -->
        <div id="message-box" class="text-white bg-blue-500 p-4 rounded-lg mb-4 hidden"></div>

        <!-- 로그인/회원가입 뷰 -->
        <div id="login-view" class="section-card">
            <h2 id="auth-title">로그인</h2>
            <div class="input-area">
                <input type="email" id="email-input" placeholder="이메일">
                <input type="password" id="password-input" placeholder="비밀번호">
                <button id="auth-button">로그인</button>
            </div>
            <button id="toggle-auth-mode" class="auth-toggle-btn">계정이 없으신가요? 회원가입</button>
            <p id="user-id-display" class="mt-4 text-sm text-gray-400" style="display: none;"></p>
        </div>

        <!-- 목표 설정 뷰 (초기에는 숨김) -->
        <div id="goal-setting-view" class="section-card" style="display: none;">
            <p id="logged-in-user-info" class="text-gray-400 text-sm mb-4"></p>
            <h2>오늘의 다짐</h2>
            <div class="input-area">
                <input type="text" id="goal-input-1" placeholder="첫 번째 다짐을 입력하세요">
                <input type="text" id="goal-input-2" placeholder="두 번째 다짐을 입력하세요">
                <input type="text" id="goal-input-3" placeholder="세 번째 다짐을 입력하세요">
                <button id="set-goals-btn">확인</button>
            </div>
            <button id="go-to-review-btn" class="mt-8">결과 보기</button>
            <button id="logout-button" class="mt-4 bg-red-500 hover:bg-red-700">로그아웃</button>
        </div>

        <!-- 목표 확인 및 통계 뷰 (초기에는 숨김) -->
        <div id="goal-review-view" class="section-card" style="display: none;">
            <p id="encouragement-message" class="text-green-400 font-bold mb-4"></p>
            <ul id="goal-list">
                <!-- JavaScript로 목표가 여기에 동적으로 추가됩니다 -->
                <p class="text-gray-400 text-center py-4">아직 설정된 목표가 없습니다.</p>
            </ul>
            <!-- 달성 상태 저장 버튼 (목표 설정 후 표시) -->
            <button id="save-status-btn" class="mt-4">달성 상태 저장</button>

            <h2 class="mt-10">달성률 통계</h2>
            <div class="tab-buttons">
                <button id="weekly-view-btn" class="active">주간 보기</button>
                <button id="monthly-view-btn">월간 보기</button>
            </div>
            
            <!-- 주간 보기 그래프 영역 -->
            <div id="weekly-chart-container" class="chart-container">
                <canvas id="achievement-chart"></canvas>
            </div>

            <!-- 월간 보기 달력 영역 -->
            <div id="monthly-calendar-view" class="chart-container" style="display: none;">
                <div class="calendar-header">
                    <button id="prev-month-btn">&lt;</button>
                    <span id="current-month-year" class="text-xl font-semibold"></span>
                    <button id="next-month-btn">&gt;</button>
                </div>
                <div class="calendar-weekdays">
                    <div>월</div>
                    <div>화</div>
                    <div>수</div>
                    <div>목</div>
                    <div>금</div>
                    <div>토</div>
                    <div>일</div>
                </div>
                <div id="calendar-grid">
                    <!-- Calendar days will be rendered here by JavaScript -->
                </div>
            </div>

            <button id="back-to-setting-btn" class="mt-8">목표 설정으로 돌아가기</button>
        </div>
    </div>

    <!-- 일별 목표 확인 모달 (팝업) -->
    <div id="daily-goal-modal" class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center p-4 z-50 hidden">
        <div id="daily-goal-modal-content" class="bg-[#3a3a3a] p-6 rounded-lg shadow-xl w-full max-w-md relative">
            <button id="close-modal-btn" class="absolute top-3 right-3 text-gray-400 hover:text-white text-2xl">&times;</button>
            <h3 id="modal-date" class="text-xl font-bold mb-4 text-white"></h3>
            <ul id="modal-goal-list" class="text-left">
                <!-- Goals will be loaded here -->
            </ul>
            <button id="save-modal-status-btn" class="mt-6 w-full">저장</button>
        </div>
    </div>

    <script type="module">
        // Firebase 전역 변수를 가져옵니다.
        // 이 변수들은 위쪽 <script type="module"> 블록에서 이미 설정되어 있습니다.
        const auth = window.firebaseAuth;
        const db = window.firebaseDb;
        const appId = window.appId;
        const initialAuthToken = window.initialAuthToken;

        // Firebase Firestore 관련 함수들을 가져옵니다.
        import { doc, setDoc, collection, query, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        // Firebase Authentication 관련 함수들을 가져옵니다.
        import { createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged, signInWithCustomToken, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";


        document.addEventListener('DOMContentLoaded', () => {
            const currentDateElement = document.getElementById('current-date');
            const goalInputs = [
                document.getElementById('goal-input-1'),
                document.getElementById('goal-input-2'),
                document.getElementById('goal-input-3')
            ];
            const setGoalsBtn = document.getElementById('set-goals-btn');
            const goalList = document.getElementById('goal-list');
            const saveStatusBtn = document.getElementById('save-status-btn');
            const messageBox = document.getElementById('message-box');
            const goToReviewBtn = document.getElementById('go-to-review-btn');
            const backToSettingBtn = document.getElementById('back-to-setting-btn');
            const goalSettingView = document.getElementById('goal-setting-view');
            const goalReviewView = document.getElementById('goal-review-view');
            const weeklyViewBtn = document.getElementById('weekly-view-btn');
            const monthlyViewBtn = document.getElementById('monthly-view-btn');
            const weeklyChartContainer = document.getElementById('weekly-chart-container');
            const monthlyCalendarView = document.getElementById('monthly-calendar-view');
            const achievementChartCanvas = document.getElementById('achievement-chart');
            const encouragementMessageElement = document.getElementById('encouragement-message');
            const currentMonthYearElement = document.getElementById('current-month-year');
            const prevMonthBtn = document.getElementById('prev-month-btn');
            const nextMonthBtn = document.getElementById('next-month-btn');
            const calendarGrid = document.getElementById('calendar-grid');

            // 모달 관련 요소
            const dailyGoalModal = document.getElementById('daily-goal-modal');
            const closeModalBtn = document.getElementById('close-modal-btn');
            const modalDateElement = document.getElementById('modal-date');
            const modalGoalList = document.getElementById('modal-goal-list');
            const saveModalStatusBtn = document.getElementById('save-modal-status-btn');

            // 로그인 관련 요소
            const loginView = document.getElementById('login-view');
            const emailInput = document.getElementById('email-input');
            const passwordInput = document.getElementById('password-input');
            const authButton = document.getElementById('auth-button');
            const toggleAuthModeBtn = document.getElementById('toggle-auth-mode');
            const authTitle = document.getElementById('auth-title');
            const logoutButton = document.getElementById('logout-button');
            const loggedInUserInfo = document.getElementById('logged-in-user-info');
            const userIdDisplay = document.getElementById('user-id-display');


            let dailyGoals = []; 
            let current_date = ''; 
            let currentDayData = null; 
            let achievementChart = null; 
            let currentCalendarDate = new Date(); // 월간 달력의 현재 표시 월/년
            let isSignUpMode = false; // 로그인/회원가입 모드 전환

            // 현재 로그인된 사용자 ID
            let currentUserId = null;

            // 응원 문구 목록
            const encouragementMessages = [
                "오늘도 멋진 하루를 만들고 계시네요!",
                "포기하지 않는 당신의 열정을 응원합니다!",
                "작은 습관이 모여 큰 변화를 만듭니다.",
                "오늘의 노력이 내일의 당신을 만듭니다.",
                "최고의 당신을 위해 오늘도 파이팅!",
                "당신은 이미 충분히 잘하고 있어요!",
                "꾸준함이 답입니다. 계속 나아가세요!",
                "오늘도 목표를 향해 한 걸음 더!",
                "당신의 성장을 응원합니다. 대단해요!",
                "오늘도 수고 많으셨습니다. 내일도 기대돼요!"
            ];

            // 메시지 박스를 표시하는 함수
            function showMessage(message, type = 'info') {
                messageBox.textContent = message;
                messageBox.className = 'text-white p-4 rounded-lg mb-4 show'; 
                if (type === 'success') {
                    messageBox.classList.add('bg-green-500');
                    messageBox.classList.remove('bg-blue-500', 'bg-red-500');
                } else if (type === 'error') {
                    messageBox.classList.add('bg-red-500');
                    messageBox.classList.remove('bg-blue-500', 'bg-green-500');
                } else { 
                    messageBox.classList.add('bg-blue-500');
                    messageBox.classList.remove('bg-green-500', 'bg-red-500');
                }

                setTimeout(() => {
                    messageBox.classList.remove('show');
                    setTimeout(() => {
                        messageBox.style.display = 'none';
                    }, 500); 
                }, 3000);
            }

            // 뷰를 전환하는 함수
            function showView(viewId) {
                loginView.style.display = 'none';
                goalSettingView.style.display = 'none';
                goalReviewView.style.display = 'none';

                if (viewId === 'login') {
                    loginView.style.display = 'block';
                } else if (viewId === 'setting') {
                    goalSettingView.style.display = 'block';
                } else if (viewId === 'review') {
                    goalReviewView.style.display = 'block';
                    renderGoals(); // 현재 날짜의 목표를 다시 렌더링
                    displayEncouragement(); // 응원 문구 표시

                    // 현재 활성화된 탭에 따라 차트 또는 달력 렌더링
                    if (weeklyViewBtn.classList.contains('active')) {
                        weeklyChartContainer.style.display = 'block';
                        monthlyCalendarView.style.display = 'none';
                        renderWeeklyChart();
                    } else { // monthlyViewBtn.classList.contains('active')
                        weeklyChartContainer.style.display = 'none';
                        monthlyCalendarView.style.display = 'block';
                        renderMonthlyCalendar(currentCalendarDate);
                    }
                }
            }

            // 앱 초기화 및 사용자 인증 상태 감지
            async function initializeApp() {
                try { // initializeApp 전체를 try-catch로 감싸서 초기화 오류를 잡습니다.
                    // Canvas 환경에서 제공되는 초기 토큰으로 로그인 시도
                    if (initialAuthToken) {
                        try {
                            await signInWithCustomToken(auth, initialAuthToken);
                        } catch (error) {
                            console.error("Custom token login failed:", error);
                            // 토큰 실패 시 익명 로그인 시도 (또는 로그인 뷰 표시)
                            await signInAnonymously(auth);
                        }
                    } else {
                        // 토큰이 없으면 익명 로그인 시도 (또는 로그인 뷰 표시)
                        await signInAnonymously(auth);
                    }

                    // 인증 상태 변경 리스너
                    onAuthStateChanged(auth, async (user) => {
                        if (user) {
                            currentUserId = user.uid;
                            loggedInUserInfo.textContent = `로그인됨: ${user.email || '익명 사용자'}`;
                            userIdDisplay.textContent = `사용자 ID: ${currentUserId}`;
                            userIdDisplay.style.display = 'block'; // 사용자 ID 표시

                            // 로그인 후 목표 데이터 로드
                            await loadUserGoals(currentUserId);
                            showView('setting'); // 목표 설정 뷰로 전환
                        } else {
                            currentUserId = null;
                            dailyGoals = []; // 사용자 로그아웃 시 데이터 초기화
                            loggedInUserInfo.textContent = '';
                            userIdDisplay.style.display = 'none'; // 사용자 ID 숨김
                            showView('login'); // 로그인 뷰로 전환
                        }
                    });
                } catch (error) {
                    console.error("Firebase 앱 초기화 실패:", error);
                    showMessage("앱 초기화에 실패했습니다. Firebase 설정을 확인해주세요.", 'error');
                    showView('login'); // 초기화 실패 시에도 로그인 화면을 보여줍니다.
                }
            }

            // 사용자 목표 데이터 로드
            async function loadUserGoals(userId) {
                if (!userId) return;

                const userGoalsCollectionRef = collection(db, `artifacts/${appId}/users/${userId}/dailyGoals`);
                
                // Firestore에서 실시간으로 데이터를 가져옵니다.
                onSnapshot(userGoalsCollectionRef, (snapshot) => {
                    dailyGoals = snapshot.docs.map(doc => doc.data());
                    
                    const today = new Date();
                    const year = today.getFullYear();
                    const month = String(today.getMonth() + 1).padStart(2, '0'); 
                    const day = String(today.getDate()).padStart(2, '0');     
                    const formattedDate = `${year}년 ${month}월 ${day}일`; 

                    current_date = formattedDate; 
                    currentDayData = dailyGoals.find(data => data.date === formattedDate);

                    if (!currentDayData) {
                        currentDayData = { date: formattedDate, goals: [] };
                        // 새 날짜 데이터는 Firestore에 즉시 추가하지 않고, 사용자가 목표를 설정할 때 추가합니다.
                    }

                    // 목표 설정 입력 필드 업데이트
                    goalInputs.forEach((input, index) => {
                        if (currentDayData.goals[index]) {
                            input.value = currentDayData.goals[index].text;
                        } else {
                            input.value = ''; 
                        }
                    });

                    // 현재 뷰가 'review'라면 UI 업데이트
                    if (goalReviewView.style.display === 'block') {
                        renderGoals();
                        displayEncouragement();
                        if (weeklyViewBtn.classList.contains('active')) {
                            renderWeeklyChart();
                        } else if (monthlyViewBtn.classList.contains('active')) {
                            renderMonthlyCalendar(currentCalendarDate);
                        }
                    }
                });
            }

            // currentDayData의 goals 배열의 내용을 바탕으로 목표 목록을 화면에 렌더링하는 함수
            function renderGoals() {
                goalList.innerHTML = ''; 

                if (!currentDayData || currentDayData.goals.length === 0) {
                    const noGoalMessage = document.createElement('p');
                    noGoalMessage.textContent = '아직 설정된 목표가 없습니다.';
                    noGoalMessage.className = 'text-gray-400 text-center py-4'; 
                    goalList.appendChild(noGoalMessage);
                    return;
                }

                currentDayData.goals.forEach((goal, index) => {
                    const listItem = document.createElement('li');
                    listItem.textContent = goal.text; 

                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.checked = goal.completed; 
                    checkbox.dataset.index = index; 

                    checkbox.addEventListener('change', (e) => {
                        currentDayData.goals[index].completed = e.target.checked; 
                        if (e.target.checked) {
                            listItem.classList.add('completed');
                        } else {
                            listItem.classList.remove('completed');
                        }
                        saveAllGoals(); // Firestore에 저장
                        if (weeklyViewBtn.classList.contains('active')) {
                            renderWeeklyChart();
                        } else if (monthlyViewBtn.classList.contains('active')) {
                            renderMonthlyCalendar(currentCalendarDate); // 달력 업데이트
                        }
                        displayEncouragement(); 
                    });

                    if (goal.completed) {
                        listItem.classList.add('completed');
                    }

                    listItem.appendChild(checkbox); 
                    goalList.appendChild(listItem); 
                });
            }

            // "확인" 버튼 클릭 이벤트 리스너 (목표 설정/수정)
            setGoalsBtn.addEventListener('click', async () => {
                const newGoals = [];
                goalInputs.forEach(input => {
                    if (input.value.trim() !== '') { 
                        newGoals.push({ text: input.value.trim(), completed: false });
                    }
                });

                if (newGoals.length > 0) {
                    const isNewGoalSet = currentDayData.goals.length === 0;
                    currentDayData.goals = newGoals; 
                    await saveAllGoals(); // Firestore에 저장
                    
                    if (isNewGoalSet) {
                        showMessage('오늘의 다짐이 설정되었습니다!', 'success');
                    } else {
                        showMessage('오늘의 다짐이 수정되었습니다!', 'success'); 
                    }
                } else {
                    showMessage('최소 하나의 다짐을 입력해주세요.', 'error');
                }
            });

            // "달성 상태 저장" 버튼 클릭 이벤트 리스너 (저녁)
            saveStatusBtn.addEventListener('click', async () => {
                await saveAllGoals(); // Firestore에 저장
                showMessage('목표 달성 상태가 저장되었습니다!', 'success');
                displayEncouragement(); 
            });

            // "결과 보기" 버튼 클릭 이벤트
            goToReviewBtn.addEventListener('click', () => {
                showView('review');
            });

            // "목표 설정으로 돌아가기" 버튼 클릭 이벤트
            backToSettingBtn.addEventListener('click', () => {
                showView('setting');
            });

            // 주간 보기 버튼 클릭 이벤트
            weeklyViewBtn.addEventListener('click', () => {
                weeklyViewBtn.classList.add('active');
                monthlyViewBtn.classList.remove('active');
                weeklyChartContainer.style.display = 'block';
                monthlyCalendarView.style.display = 'none';
                renderWeeklyChart();
            });

            // 월간 보기 버튼 클릭 이벤트
            monthlyViewBtn.addEventListener('click', () => {
                monthlyViewBtn.classList.add('active');
                weeklyViewBtn.classList.remove('active');
                weeklyChartContainer.style.display = 'none';
                monthlyCalendarView.style.display = 'block';
                renderMonthlyCalendar(currentCalendarDate);
            });

            // Firestore에 모든 dailyGoals 데이터를 저장하는 함수
            async function saveAllGoals() {
                if (!currentUserId) {
                    showMessage('로그인이 필요합니다.', 'error');
                    return;
                }
                // Firestore 문서 ID로 날짜를 사용합니다.
                const docRef = doc(db, `artifacts/${appId}/users/${currentUserId}/dailyGoals`, current_date);
                await setDoc(docRef, currentDayData, { merge: true }); // merge: true는 기존 필드를 덮어쓰지 않고 업데이트합니다.
            }

            // 특정 날짜의 달성률을 계산하는 헬퍼 함수
            function calculateAchievement(dayData) {
                if (!dayData || !dayData.goals || dayData.goals.length === 0) {
                    return 0; // 목표가 없으면 0%
                }
                const completedGoals = dayData.goals.filter(goal => goal.completed).length;
                return (completedGoals / dayData.goals.length) * 100;
            }

            // 달성률에 따라 별점 문자열을 반환하는 함수
            function getStarRating(percentage) {
                if (percentage === 0) return "☆☆☆"; 
                if (percentage <= 33) return "⭐️☆☆";
                if (percentage <= 66) return "⭐️⭐️☆";
                return "⭐️⭐️⭐️";
            }

            // 응원 문구를 표시하는 함수 (매번 다른 문구가 나오도록 Math.random() 사용)
            function displayEncouragement() {
                const achievementPercentage = calculateAchievement(currentDayData);
                let message = "";

                if (currentDayData.goals.length === 0) {
                    message = "아직 오늘의 다짐을 설정하지 않으셨네요! 지금 바로 시작해보세요.";
                } else if (achievementPercentage === 100) {
                    message = "모든 목표를 달성하셨습니다! 정말 대단해요!";
                } else { 
                    const index = Math.floor(Math.random() * encouragementMessages.length);
                    message = encouragementMessages[index];
                }
                encouragementMessageElement.textContent = message;
            }

            // Chart.js를 사용하여 차트를 렌더링하는 함수 (주간 보기용)
            function renderChart(labels, data, title) {
                if (achievementChart) {
                    achievementChart.destroy(); 
                }

                achievementChart = new Chart(achievementChartCanvas, {
                    type: 'bar', 
                    data: {
                        labels: labels,
                        datasets: [{
                            label: '달성률',
                            data: data,
                            backgroundColor: 'rgba(106, 158, 232, 0.6)', 
                            borderColor: 'rgba(106, 158, 232, 1)',
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: title,
                                font: {
                                    size: 18,
                                    color: '#f0f0f0' 
                                }
                            },
                            legend: {
                                display: false 
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const percentage = context.parsed.y;
                                        const stars = getStarRating(percentage);
                                        return `달성률: ${percentage.toFixed(1)}% ${stars}`;
                                    }
                                }
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100, 
                                title: {
                                    display: false, /* "달성률(%)" 텍스트 삭제 */
                                },
                                ticks: {
                                    color: '#e0e0e0', 
                                    callback: function(value) {
                                        return getStarRating(value); // Y축 눈금을 별점으로 표시
                                    }
                                },
                                grid: {
                                    color: '#444444' 
                                }
                            },
                            x: {
                                title: {
                                    display: true,
                                    text: '날짜',
                                    color: '#e0e0e0' 
                                },
                                ticks: {
                                    color: '#e0e0e0' 
                                },
                                grid: {
                                    color: '#444444' 
                                }
                            }
                        }
                    }
                });
            }

            // 주간 달성률 차트 렌더링 (월요일부터 시작)
            function renderWeeklyChart() {
                const today = new Date();
                const labels = [];
                const data = [];

                // 현재 주의 월요일을 찾습니다 (getDay()는 일요일이 0, 월요일이 1)
                const dayOfWeek = today.getDay(); // 0 (일) ~ 6 (토)
                // 월요일을 0으로, 일요일을 6으로 조정 (ISO 주차 기준)
                const startOfWeek = new Date(today);
                startOfWeek.setDate(today.getDate() - (dayOfWeek === 0 ? 6 : dayOfWeek - 1)); // 현재 주의 월요일로 설정

                // 월요일부터 7일간의 데이터 수집
                for (let i = 0; i < 7; i++) {
                    const d = new Date(startOfWeek);
                    d.setDate(startOfWeek.getDate() + i);
                    const formattedDate = `${d.getFullYear()}년 ${String(d.getMonth() + 1).padStart(2, '0')}월 ${String(d.getDate()).padStart(2, '0')}일`;
                    labels.push(`${String(d.getMonth() + 1).padStart(2, '0')}/${String(d.getDate()).padStart(2, '0')}\n(${['월', '화', '수', '목', '금', '토', '일'][(d.getDay() === 0 ? 6 : d.getDay() - 1)]})`); // 월/일 (요일) 형식
                    
                    const dayData = dailyGoals.find(item => item.date === formattedDate);
                    data.push(calculateAchievement(dayData));
                }
                renderChart(labels, data, '주간 목표 달성률');
            }

            // 월간 달력 렌더링
            function renderMonthlyCalendar(date) {
                calendarGrid.innerHTML = ''; // 기존 달력 내용 초기화
                currentMonthYearElement.textContent = `${date.getFullYear()}년 ${date.getMonth() + 1}월`;

                const year = date.getFullYear();
                const month = date.getMonth(); // 0-11

                // 해당 월의 첫째 날과 마지막 날
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const numDaysInMonth = lastDayOfMonth.getDate();

                // 첫째 날의 요일 (0:일, 1:월, ..., 6:토)
                // 달력은 월요일부터 시작하므로, 일요일(0)은 6으로, 월요일(1)은 0으로 조정
                const firstDayOfWeek = (firstDayOfMonth.getDay() === 0 ? 6 : firstDayOfMonth.getDay() - 1); 

                // 이전 달의 마지막 날짜부터 채우기 (달력 첫 줄 채우기)
                for (let i = 0; i < firstDayOfWeek; i++) {
                    const dayCell = document.createElement('div');
                    dayCell.classList.add('calendar-day', 'other-month');
                    calendarGrid.appendChild(dayCell);
                }

                // 현재 월의 날짜 채우기
                for (let day = 1; day <= numDaysInMonth; day++) {
                    const dayCell = document.createElement('div');
                    dayCell.classList.add('calendar-day');
                    
                    const currentDate = new Date(year, month, day);
                    const formattedDate = `${currentDate.getFullYear()}년 ${String(currentDate.getMonth() + 1).padStart(2, '0')}월 ${String(currentDate.getDate()).padStart(2, '0')}일`;

                    // 오늘 날짜 강조
                    const today = new Date();
                    if (currentDate.getDate() === today.getDate() &&
                        currentDate.getMonth() === today.getMonth() &&
                        currentDate.getFullYear() === today.getFullYear()) {
                        dayCell.classList.add('today');
                    }

                    const dayNumber = document.createElement('div');
                    dayNumber.classList.add('day-number');
                    dayNumber.textContent = day;
                    dayCell.appendChild(dayNumber);

                    const dayData = dailyGoals.find(item => item.date === formattedDate);
                    const achievement = calculateAchievement(dayData);
                    const stars = getStarRating(achievement);

                    const starsElement = document.createElement('div');
                    starsElement.classList.add('stars');
                    starsElement.textContent = stars;
                    dayCell.appendChild(starsElement);

                    // 날짜 클릭 이벤트 리스너 추가
                    dayCell.addEventListener('click', () => {
                        // 다른 달의 날짜는 클릭 불가
                        if (dayCell.classList.contains('other-month')) {
                            return;
                        }
                        showDailyGoalsPopup(formattedDate);
                    });

                    calendarGrid.appendChild(dayCell);
                }

                // 다음 달의 첫째 날짜부터 채우기 (총 6주 = 42칸을 맞추기 위함)
                const totalCells = firstDayOfWeek + numDaysInMonth;
                const remainingCells = (7 - (totalCells % 7)) % 7; // 남은 칸 계산
                if (remainingCells !== 0) { // 7의 배수가 아니면 다음달 칸 채우기
                    for (let i = 0; i < remainingCells; i++) {
                        const dayCell = document.createElement('div');
                        dayCell.classList.add('calendar-day', 'other-month');
                        calendarGrid.appendChild(dayCell);
                    }
                }
            }

            // 일별 목표 확인 팝업 표시 함수
            function showDailyGoalsPopup(dateString) {
                modalDateElement.textContent = dateString;
                modalGoalList.innerHTML = ''; // 기존 목록 초기화

                const dayData = dailyGoals.find(data => data.date === dateString);

                if (!dayData || dayData.goals.length === 0) {
                    const noGoalMessage = document.createElement('p');
                    noGoalMessage.textContent = '이 날짜에는 설정된 목표가 없습니다.';
                    noGoalMessage.className = 'text-gray-400 text-center py-4';
                    modalGoalList.appendChild(noGoalMessage);
                    saveModalStatusBtn.style.display = 'none'; // 목표 없으면 저장 버튼 숨김
                } else {
                    dayData.goals.forEach((goal, index) => {
                        const listItem = document.createElement('li');
                        listItem.textContent = goal.text;

                        const checkbox = document.createElement('input');
                        checkbox.type = 'checkbox';
                        checkbox.checked = goal.completed;
                        checkbox.dataset.date = dateString; // 어떤 날짜의 목표인지 저장
                        checkbox.dataset.index = index; // 해당 날짜의 목표 중 몇 번째 목표인지 저장

                        checkbox.addEventListener('change', async (e) => { // async 추가
                            const targetDate = e.target.dataset.date;
                            const targetIndex = parseInt(e.target.dataset.index);
                            
                            const foundDayData = dailyGoals.find(data => data.date === targetDate);
                            if (foundDayData) {
                                foundDayData.goals[targetIndex].completed = e.target.checked;
                                // 체크박스 상태에 따라 스타일 변경
                                if (e.target.checked) {
                                    listItem.classList.add('completed');
                                } else {
                                    listItem.classList.remove('completed');
                                }
                                await saveAllGoalsForDate(foundDayData); // 해당 날짜 데이터만 Firestore에 저장
                                renderMonthlyCalendar(currentCalendarDate); // 달력 별점 업데이트
                                renderWeeklyChart(); // 주간 차트 업데이트
                                // 만약 오늘 날짜의 목표를 팝업에서 수정했다면, 메인 화면의 응원 문구도 업데이트
                                if (targetDate === current_date) {
                                    displayEncouragement();
                                }
                            }
                        });

                        if (goal.completed) {
                            listItem.classList.add('completed');
                        }
                        listItem.appendChild(checkbox);
                        modalGoalList.appendChild(listItem);
                    });
                    saveModalStatusBtn.style.display = 'block'; // 목표 있으면 저장 버튼 표시
                }
                dailyGoalModal.style.display = 'flex'; // 모달 표시
            }

            // 모달 닫기 버튼 이벤트
            closeModalBtn.addEventListener('click', () => {
                dailyGoalModal.style.display = 'none';
            });

            // 모달 저장 버튼 이벤트 (체크박스 변경 시 이미 저장되므로, 닫기 기능만 수행)
            saveModalStatusBtn.addEventListener('click', () => {
                dailyGoalModal.style.display = 'none';
                showMessage('목표 달성 상태가 저장되었습니다!', 'success');
            });


            // 이전 달로 이동
            prevMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1);
                renderMonthlyCalendar(currentCalendarDate);
            });

            // 다음 달로 이동
            nextMonthBtn.addEventListener('click', () => {
                currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1);
                renderMonthlyCalendar(currentCalendarDate);
            });

            // 앱 로드 시 초기화 함수 호출
            initializeApp(); // Firebase 초기화 및 인증 상태 감지 시작
        });
    </script>
</body>
</html>
